/**
Created By: MICP-ICT
*/
$(window).on('load', function(){
	// Asynchronous Sign Up

	//instantiations
	var orangeForm_username=$("#orangeForm-username"), 
		orangeForm_email=$("#orangeForm-email"),
		orangeForm_pass=$("#orangeForm-pass"),
		orangeForm_confirm_pass = $("#orangeForm_confirm_pass")
		status_username=false, status_email=false, status_pass=false
		status_confirm_pass=false;
	//instantiations
	//returns true if requirements have been met
	function username_filter(username){
		var allDigits = /^[0-9]+$/g,
        allHyphens = /^[-]+$/g, //doesn't need a character class, but I find it's more readable
        multiHyphens = /[-]+/g,
        startsWith = /^[A-Za-z0-9]{1}/,
        endsWith = /[A-Za-z0-9]{1}$/
        hasInvalidChars = /[^A-Za-z0-9-]/,
        meetsReqs = false;
    	if (username.length >= 8 && username.length <= 17) { //ensure correct length
        	meetsReqs = !allDigits.test(username);
        	meetsReqs = meetsReqs && !allHyphens.test(username);
        	meetsReqs = meetsReqs && !multiHyphens.test(username);
        	meetsReqs = meetsReqs && !hasInvalidChars.test(username);
        	meetsReqs = meetsReqs && startsWith.test(username);
        	meetsReqs = meetsReqs && endsWith.test(username);
    	}
    	
    	return meetsReqs;
	}
	//validate username length, availablity, and pattern
	orangeForm_username.bind('keyup focusout',function(){
		if(username_filter(orangeForm_username.val())==false){
			orangeForm_username.removeClass('green-text').addClass('red-text')
		}
		else{
			$.ajax({
			url:orangeForm_username.attr('data-url'),
			data:{username:orangeForm_username.val()},
			success: function(data){
					status_username=data.status;
					if(status_username==false){
						orangeForm_username.removeClass('green-text').addClass('red-text')
					}
					else{
						orangeForm_username.removeClass('red-text').addClass('green-text')
					}
			},
			error: function(data){
				status_username=false
			}
		})
		}
	})
	//do ajax validation for username uniqueness
	
	//validate email
	function email_filter(email){
		var reg_email = /^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;
		return reg_email.test(email);
	}

	orangeForm_email.bind('keyup focusout',function(){
		if(email_filter(orangeForm_email.val())){
			$.ajax({
				url:orangeForm_email.attr('data-url'),
				type:'GET',
				// dataType:'json',
				data: {email:orangeForm_email.val()},
				success:function(response){
					status_email=response.status;
					if(status_email==false){
						orangeForm_email.attr('class','red-text')
					}
					else{
						orangeForm_email.attr('class','green-text')
					}
				},
				error: function(){
					status_email=false
				}
			})
		}
		else{
			orangeForm_email.addClass('red-text')
			status_email=false
		}
	})

	//measures password strength
	function mete_password(password){
		//do nothing if password length is zero
		if(password.length==0){
			return 0;
		}
		// Create an array and push all possible values that you want in password
        var matchedCase = new Array();
        matchedCase.push("[$@$!%*#?&]"); // Special Charector
        matchedCase.push("[A-Z]");      // Uppercase Alpabates
        matchedCase.push("[0-9]");      // Numbers
        matchedCase.push("[a-z]");     // Lowercase Alphabates

    	// Check the conditions
        var ctr = 0;
        for (var i = 0; i < matchedCase.length; i++) {
            if (new RegExp(matchedCase[i]).test(password)) {
                 ctr++;
            }
        }
        return ctr;

	}
	//validate password input on keyup
	orangeForm_pass.keyup(function(){
	    passwordStrength=mete_password(orangeForm_pass.val());
		switch(passwordStrength){//identification colors used [red,orange,green]
			case 0:case 1: case 2:
				orangeForm_pass.attr('class','red-text');break;
			case 3: 
				orangeForm_pass.attr('class','orange-text');break;
			case 4:
				orangeForm_pass.attr('class','green-text');break;
		}		

	})

	orangeForm_confirm_pass.keyup(function(){
		var password=orangeForm_pass.val();
		if(password.localeCompare(orangeForm_confirm_pass.val())==0){
			orangeForm_confirm_pass.attr('class','green-text')
			orangeForm_pass.attr('class', 'green-text')
			status_confirm_pass=true
		}
		else{
			orangeForm_confirm_pass.attr('class','red-text')
			status_confirm_pass=false
		}
	})
	//submit credentials upon successful validation
	$("#SignUpFormBtn").click(function(){
		//check for validation failure
		switch(false){
			case status_username:
			case status_email:
			case status_confirm_pass:alert('Make sure all fields are green.');
			$(this).removeClass('disabled').text('Sign Up'); return false;break;
		}
		$(this).addClass('disabled').text('Signing Up...')
		$.ajax({
			url: $(this).attr('data-url'),
			type: 'POST',
			data: {
				username: orangeForm_username.val(),
				email: orangeForm_email.val(),
				password:orangeForm_pass.val(),
				password_confirmation:orangeForm_confirm_pass.val(),
			},
			statusCode: {
				200: function(response){
					$("#modalRegisterForm").modal('hide')
					alert(response.status)
				},
				422: function(response){
					alert(response.error);
					return false;
				},
			}
		}).always(function(){
			window.location.reload()
		})
	})

	$("#formLogin").on('submit',function(e){
		$(this).find('.btn-default').text('Signing In...')
		e.preventDefault();
		var $this=$(this);
		$.ajax({
			url: $this.attr('action'),
			type: 'POST',
			data: $this.serialize(),
			statusCode:{
				200: function(data){
					$(this).find('.btn-default').text(data.message);
					Vue.toasted.show(data.message + ' successfully.')
					window.location.reload()
				},
				202: function(data){
					Vue.toasted.show('.btn-default').text(data.message);
				}
			},
		})

	})
})